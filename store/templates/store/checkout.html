{% extends 'store/base.html' %}
{% load static %}
{% block content %}
<div class="bg-white">
	<!-- Background color split screen for large screens -->
	<div class="fixed left-0 top-0 hidden h-full w-1/2 bg-white lg:block" aria-hidden="true"></div>
	<div class="fixed right-0 top-0 hidden h-full w-1/2 bg-gray-50 lg:block" aria-hidden="true"></div>
  
	<div class="relative mx-auto grid max-w-7xl grid-cols-1 gap-x-16 lg:grid-cols-2 lg:px-8 xl:gap-x-48">
	  <h1 class="sr-only">Order information</h1>
  
	  <section aria-labelledby="summary-heading" class="bg-gray-50 px-4 pb-10 pt-16 sm:px-6 lg:col-start-2 lg:row-start-1 lg:bg-transparent lg:px-0 lg:pb-16">
		<div class="mx-auto max-w-lg lg:max-w-none">
		  <h2 id="summary-heading" class="text-lg font-medium text-gray-900">Order summary</h2>
  
		  <ul role="list" class="divide-y divide-gray-200 text-sm font-medium text-gray-900">
			{% for item in items %}
			<li class="flex items-center space-x-4 py-6">
			  <img src="{{item.product.imageURL}}" alt="Moss green canvas compact backpack with double top zipper, zipper front pouch, and matching carry handle and backpack straps." class="h-20 w-20 flex-none rounded-md object-cover object-center">
			  <div class="flex-auto space-y-1">
				<h3>{{item.product.name}}</h3>
			  </div>
			  <p class="flex-none text-base font-medium">&#8358;{{item.product.price}}</p>
			</li>
			{% endfor %}
  
			<!-- More products... -->
		  </ul>
  
		  <dl class="hidden space-y-6 border-t border-gray-200 pt-6 text-sm font-medium text-gray-900 lg:block">
			<div class="flex items-center justify-between">
			  <dt class="text-gray-600">Subtotal</dt>
			  <dd>&#8358;{{order.get_cart_total}}</dd>
			</div>
  
			<div class="flex items-center justify-between">
			  <dt class="text-gray-600">Shipping</dt>
			  <dd>&#8358;1500</dd>
			</div>
  
  
			<div class="flex items-center justify-between border-t border-gray-200 pt-6">
			  <dt class="text-base">Total</dt>
			  <dd class="text-base">&#8358;{{total}}</dd>
			</div>
		  </dl>
  
		  <div class="fixed inset-x-0 bottom-0 flex flex-col-reverse text-sm font-medium text-gray-900 lg:hidden">
			<div class="relative z-10 border-t border-gray-200 bg-white px-4 sm:px-6">
			  <div class="mx-auto max-w-lg">
				<button type="button" class="flex w-full items-center py-6 font-medium" aria-expanded="false">
				  <span class="mr-auto text-base">Total</span>
				  <span class="mr-2 text-base">$361.80</span>
				  <svg class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
					<path fill-rule="evenodd" d="M9.47 6.47a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 8.06l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25Z" clip-rule="evenodd" />
				  </svg>
				</button>
			  </div>
			</div>
  
			<div>
			  <!--
				Mobile summary overlay, show/hide based on mobile summary state.
  
				Entering: "transition-opacity ease-linear duration-300"
				  From: "opacity-0"
				  To: "opacity-100"
				Leaving: "transition-opacity ease-linear duration-300"
				  From: "opacity-100"
				  To: "opacity-0"
			  -->
			  <div class="fixed inset-0 bg-black bg-opacity-25" aria-hidden="true"></div>
  
			  <!--
				Mobile summary, show/hide based on mobile summary state.
  
				Entering: "transition ease-in-out duration-300 transform"
				  From: "translate-y-full"
				  To: "translate-y-0"
				Leaving: "transition ease-in-out duration-300 transform"
				  From: "translate-y-0"
				  To: "translate-y-full"
			  -->
			  <div class="relative bg-white px-4 py-6 sm:px-6">
				<dl class="mx-auto max-w-lg space-y-6">
				  <div class="flex items-center justify-between">
					<dt class="text-gray-600">Subtotal</dt>
					<dd>&#8358;{{order.get_cart_total}}</dd>
				  </div>
  
				  <div class="flex items-center justify-between">
					<dt class="text-gray-600">Shipping</dt>
					<dd>$15.00</dd>
				  </div>
  
				  <div class="flex items-center justify-between">
					<dt class="text-gray-600">Taxes</dt>
					<dd>$26.80</dd>
				  </div>
				</dl>
			  </div>
			</div>
		  </div>
		</div>
	  </section>
  
	  <div class="px-4 pb-36 pt-16 sm:px-6 lg:col-start-1 lg:row-start-1 lg:px-0 lg:pb-16">
		<div class="mx-auto max-w-lg lg:max-w-none">
		 
  
		  <section aria-labelledby="shipping-heading" class="mt-10">
			<h2 id="shipping-heading" class="text-lg font-medium text-gray-900">Shipping address</h2>
  
			<div class="mt-6 grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-3">
			  
  
			  <div class="sm:col-span-3">
				<label for="address" class="block text-sm font-medium text-gray-700">Address</label>
				<div class="mt-1">
				  <input type="text" id="id_address" name="address" autocomplete="street-address" class="block w-full border border-1 py-2 px-3 rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
				</div>
			  </div>
  
			  <div class="sm:col-span-3">
				<label for="apartment" class="block text-sm font-medium text-gray-700">Country.</label>
				<div class="mt-1">
				  <input type="text" id="id_country" name="apartment" class="block w-full rounded-md border border-1 py-2 px-3 border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
				</div>
			  </div>
  
			  <div>
				<label for="city" class="block text-sm font-medium text-gray-700">Zip Code</label>
				<div class="mt-1">
				  <input type="text" id="id_zipcode" name="city" autocomplete="address-level2" class="block w-full border border-1 py-2 px-3 rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
				</div>
			  </div>
  
			  <div>
				<label for="city" class="block text-sm font-medium text-gray-700">State</label>
				<div class="mt-1">
				  <input type="text" id="id_state" name="state" autocomplete="address-level2" class="block w-full border border-1 py-2 px-3 rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
				</div>
			  </div>

			  
  
			  
			</div>
		  </section>
  
	
  
		  <div class="mt-10 border-t border-gray-200 pt-6 sm:flex sm:items-center sm:justify-between">
			<button onclick="makePayment()" class="w-full rounded-md border border-transparent bg-orange-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-50 sm:order-last sm:ml-6 sm:w-auto">Make Payment</button>
			<p class="mt-4 text-center text-sm text-gray-500 sm:mt-0 sm:text-left"></p>
		  </div>
		</div>
	  </div>
	</div>
  </div>
<script src="https://checkout.flutterwave.com/v3.js"></script>

  <script>
	function generateTxRef() {
    // Get the current timestamp
    const timestamp = Date.now();

    // Generate a random string of 8 characters
    const randomString = Math.random().toString(36).substring(2, 10).toUpperCase();

    // Combine timestamp and random string to form a unique tx_ref
    const txRef = `TX-${timestamp}-${randomString}`;

    return txRef;
}
	function makePayment() {
	var userFormData = {
    		'name': null,
    		'email': null,
    		'total': '{{order.get_cart_total}}',
    	}
    	var shippingInfo = {
    		'address': null,
    		'country': null,
    		'state': null,
    		'zipcode': null,
    	}
		shippingInfo.address = document.querySelector('#id_address').value
		shippingInfo.country = document.querySelector('#id_country').value
		shippingInfo.state = document.querySelector('#id_state').value
		shippingInfo.zipcode = document.querySelector('#id_zipcode').value
	if ("{{order.get_cart_total}}" <= 0){
		alert('Your cart is empty')
		return
	}
	else {
	FlutterwaveCheckout({
		public_key: "FLWPUBK_TEST-492ac3f598f3ec407a39f0fad8325a83-X",
		tx_ref: generateTxRef(),
		amount: "{{order.get_cart_total}}",
		currency: "NGN",
		payment_options: "card, banktransfer, ussd",
		meta: {
		source: "docs-inline-test",
		consumer_mac: "92a3-912ba-1192a",
		},
		customer: {
		email: "{{request.user.email}}",
		phone_number: "08100000000",
		name: "{{request.user.first_name}} {{request.user.last_name}}",
		},
		customizations: {
		title: "Rayan Store",
		description: "Test Payment",
		logo: "{% static 'images/logo.jpg' %}",
		},
		callback: function (data){
			var url = '/process_order/'
			console.log('Url:', url)
		
			fetch(url, {
				method:'POST',
				headers: {
					'Content-Type':'application/json',
					'X-CSRFToken': csrftoken,
				},
				body:JSON.stringify({'form': userFormData, 'shipping': shippingInfo})
			})
			.then((response) =>{
				return response.json()
			})
			.then((data) =>{
				window.location.href = '{% url "user_delivery_status" %}'
			});
		},
		onclose: function() {
		alert("Payment cancelled!");
		}
	});
	}
}
  </script>
{% endblock %}




